# 프로세스 동기화와 문제 해결책
## 협력 프로세스(Cooperating process)
- 서로 간에 영향을 미치는 프로세스
- 논리 주소 공간을 공유할 수 있거나 데이터 공유가 허용되는 프로세스

- 공유 데이터의 동시 접근은 데이터의 불안정성을 가져올 수 있음
- 그러므로, 협력 프로세스를 순서를 갖고 실행함으로써 데이터의 동시성을 유지하도록 보장해줘야 함

## 데이터의 무결성(integrity)
- 동시 실행
    - 프로세스가 명령 스트림 중 어디서든 인터럽트가 발생할 수 있음
    - processing core가 다른 프로세스에게 부여됨
- 병렬 실행
    - 둘 이상의 명령 스트림이 각각의 processing core에서 동시에 실행됨
 
## 데이터의 불안정성(inconsistency)
- 두 프로세스가 따로따로는 잘 동작하나, 동시에 실행 중일 때는 정확히 동작하지 않을 수 있음
- 명령어가 저수준에서 실행될 때, 인터럽트 핸들러가 레지스터의 값을 저장 및 복구함
- 이때, 공유 자원과 관련된 연산이 순차적으로 실행됨을 보장할 수 없음

### 너무 많은 우유 문제(too much milk problem)
1. 가족 중 한 사람이 냉장고에 우유가 없는 것을 확인하고 우유를 사러 나감
2. 우유를 사는 동안 다른 사람 역시 냉장고에 우유가 없는 것을 확인하고 사러 나감
3. 1, 2번의 두 사람 모두 우유를 사 갖고 옴
4. 우유는 하나만 사면 됐으나, 결과적으로 2개를 사 버림

- 프로세스 역시 공유 자원의 동기화가 일어나지 않으면 다음과 같은 상황이 발생할 수 있음

## 경쟁 상태(Race Condition)
- 여러 프로세스가 같은 데이터에 동시에 접근 및 조작할 때, 실행 결과가 접근이 일어나는 순서에 좌우되는 현상
- 경쟁 상태를 막기 위해서는 특정 시간에 오직 하나의 프로세스만 공유 데이터를 다룰 수 있도록 보장해야 함
- **Process(or Thread) Synchronization**: 몇 가지 방법으로 프로세스(또는 스레드)의 동기화가 필요함

## 임계 영역(Critical Section) 문제
- 프로세스의 코드 영역 중, 다른 프로세스와 공유된 데이터에 접근이 일어날 수 있는 영역
- 한 프로세스가 임계 영역을 실행 중이라면, 다른 프로세스는 이 영역의 실행을 허용하지 않도록 하는 것이 시스템의 중요한 특징

## 코드 영역
- entry-section: 임계 영역의 접근 허가를 요청하는 코드 영역
- critical-section: entry-section 이후
- exit-section: critical-section 이후
- remainder-section: 남은 코드 영역

## 임계 영역 문제 해결을 위한 요구사항
- **상호배제(Mutual Exclusion)**: 프로세스가 임계 영역을 실행 중이라면 다른 프로세스는 그 영역을 실행할 수 없음
- **진행(Progress)**: 임계 영역을 실행 중인 프로세스가 없다면, 프로세스가 해당 영역에 접근할 수 있어야 한다. (deadlock 방지)
- **유한한 대기(bounded waiting)**: 프로세스의 임계 영역 접근은 요청 후 유한한 시간 내에 이루어져야 한다. (starvation 방지)

## 단일 코어 환경에서 해결
- 공유 변수가 수정되는 동안 인터럽트 발생 방지
- 명령어의 현재 순서대로, 도중에 선점되는 일 없이 실행됨을 보장해야 함
- 다른 명령어가 실행되지 않으므로, 공유 데이터의 예측 불가능한 수정이 일어나지 않음
- 멀티프로세서 환경에는 부적합

## 선점형 커널과 비선점형 커널
- 비선점형 커널
    - kernel mode의 프로세스는 kernel mode를 나가거나, block되거나, CPU를 자발적으로 양보할 때까지 실행됨
    - 커널 데이터 구조에서 경쟁 상태가 발생할 일이 없음
    - 단순한 설계
- 선점형 커널
    - kernel mode에서 프로세스가 실행되고 있을 때, 스케줄러가 개입해 다른 프로세스의 선점을 허용 가능
    - 설계하기 어려움
    - 좀 더 반응형으로 동작(responsive)하므로 선호됨

## 임계 영역 문제의 소프트웨어적 해결
- Dekker’s Algorithm: 두 프로세스에 대해서
- Eisenberg and McGuire’s Algorithm: n-1 차례의 대기 시간을 lower bound로 가지는 n개의 프로세스에 대하여
- Bakery Algorithm
- **Peterson’s Algorithm**
    - 임계 영역 문제의 고전적인 소프트웨어 해결법
    - 현대 컴퓨터는 load와 store와 같은 기계어 명령어를 수행하므로, 정확히 동작할 거란 보장은 없음

## Peterson’s solution
- 두 프로세스가 임계 영역과 나머지 영역(remainder section)을 번갈아 실행하도록 제한
- 한쪽 프로세스가 임계 영역을 실행 중이면 다른 한쪽 프로세스는 대기
- flag와 turn 변수 사용
- 제대로 동작할 거란 보장이 없음
    - 시스템 성능을 향상시키기 위해 프로세서 또는 컴파일러가 종속성이 없는 읽기 및 쓰기 작업의 순서를 바꿀 수 있음
    - 만약 flag와 turn 변수의 업데이트 순서가 뒤바뀐다면, 이상 발생
- 임계 영역 문제를 해결하는 좋은 알고리즘 개념을 제공
- 상호배제, 진행, 유한한 대기의 요구사항이 포함된 복잡성 일부를 나타내줌
    - 상호배제는 보존된다.
    - 진행의 요구사항을 만족한다. (deadlock 없음)
    - 유한한 대기의 요구사항을 충족한다. (기아 상태 없음)

## Atomicity(원자성)
- atomic operation: 인터럽트를 걸 수 없는 동작의 단위
- 더 이상 나눌 수 없는 작업의 단위
- 데이터 무결성을 보장하고, 경쟁 상태를 방지하기 위해 원자성이 보장되어야 함
- 현대 컴퓨터 시스템은 특수한 하드웨어 명령어를 제공함 (ex: atomic instructions)
    - word 내용의 테스트와 수정을 허용하거나, 두 word의 내용을 바꾸는 것이 허용됨
- 개념적인 원자 명령어의 두 종류
    - test_and_set()
    - compare_and_swap()

### Atomic Variable
- 일반적으로, compare_and_swap() 명령은 atomic variable을 만드는 도구로 사용할 수 있음
- 기본 데이터 타입(integer, boolean 등)에 대한 원자 연산(atomic operation) 제공
- 하나의 변수에 대해 경쟁 상태가 발생할 때, 상호배제 보장을 위해 사용될 수 있음
